import re
import base64
import json
import tkinter as tk
from tkinter import scrolledtext


def decode_jwt_component(component):

    decoded_component = base64.urlsafe_b64decode(
        component + '=' * (4 - len(component) % 4)).decode('utf-8')
    return json.loads(decoded_component)
    """except json.JSONDecodeError as e:
        print(f"Error decoding JSON: {e}")
        return None """


def find_and_decode_jwt(http_request_text: str) -> dict:
    # Define the regex pattern for JWT
    jwt_pattern = r'^([A-Za-z0-9\-\._~\+\/]+)\.([A-Za-z0-9\-\._~\+\/]+)\.([A-Za-z0-9\-\._~\+\/]+)$'
    return_dict = {"status": False, "messages": {}}

    # Search for JWTs in Cookie
    cookie_match = re.search(r'Cookie:.*?session=([^\s;]+)', http_request_text)
    if cookie_match:
        jwt_match = re.match(jwt_pattern, cookie_match.group(1))
        if jwt_match:

            # Decode and print header and payload
            header, payload, signature = jwt_match.groups()
            decoded_header = decode_jwt_component(header)
            decoded_payload = decode_jwt_component(payload)

            if decoded_header and decoded_payload:
                return_dict["status"] = True
                return_dict["messages"]["Token"] = jwt_match.group(0)
                return_dict["messages"]["Decoded Header"] = json.dumps(
                    decoded_header, indent=2)
                return_dict["messages"]["Decoded Payload"] = json.dumps(
                    decoded_payload, indent=2)

    return return_dict


if __name__ == "__main__":

    # url = input("Enter the target requet? ")
    url = """
        GET /my-account?id=wiener HTTP/2
Host: 0a2e006e03b1de6280b2f38800ab00a9.web-security-academy.net
Cookie: session=eyJraWQiOiI2MzViMGU5MC1jNjQzLTQ3M2YtYTEyNC0wNmZjODk3ZWZkNGEiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJwb3J0c3dpZ2dlciIsImV4cCI6MTcxNzkyNzUzOSwic3ViIjoid2llbmVyIn0.-adGp0WSTZAmWTJ-RrW42pJp5vH9DrQNFHVZytzwjM4
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.6422.112 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,/;q=0.8,application/signed-exchange;v=b3;q=0.7
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Sec-Ch-Ua: "Chromium";v="125", "Not.A/Brand";v="24"
Sec-Ch-Ua-Mobile: ?0
Sec-Ch-Ua-Platform: "Windows"
Referer: https://0a2e006e03b1de6280b2f38800ab00a9.web-security-academy.net/login
Accept-Encoding: gzip, deflate, br
Accept-Language: en-US,en;q=0.9
Priority: u=0, i
        """
        
    print(find_and_decode_jwt(url))
