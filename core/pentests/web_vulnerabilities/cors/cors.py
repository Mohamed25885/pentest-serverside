import requests
import validators
import re
import tldextract

def add_header(original_headers, new_headers):
    merged_headers = {**original_headers, **new_headers}
    return merged_headers


def check_origin(url, headers, origin):
    headers["Origin"] = origin
    response = requests.get(url, headers=headers)
    return "Access-Control-Allow-Origin" in response.headers and response.headers["Access-Control-Allow-Origin"] == origin


def cors(url:str, cookie:str = None):

    headers = {
        "Cookie": f"session={cookie}",
        "Origin": "*",
        "User-Agent": "Mozilla/5.0",
        "Accept": "*/*",
        "Accept-Language": "en-US,en;q=0.5",
        "Accept-Encoding": "gzip, deflate, br"
    }
    if not validators.url(url):
        raise ValueError("Invalid URL format")
    else:
        domain = tldextract.extract(url)
        # check credentials
        credentials = 0
        response = requests.get(url)
        response = requests.get(url, headers=headers)
        credentials |= "Access-Control-Allow-Credentials" in response.headers and response.headers["Access-Control-Allow-Credentials"] == "true"


        # check wildcard
        wildcard = check_origin(url, headers, "*")

        # check attacker as origin
        attacker_origin = check_origin(url, headers, "attacker_origin.com")

        # check null origin
        null_origin = check_origin(url, headers, "null")

        # check subdomain
        subdomain = check_origin(url, headers, f"test.{domain.registered_domain}")

        # check subdomain for subdomain
        subdomain_for_subdomain = check_origin(url, headers, f"test1.test2.{domain.registered_domain}")
        
        rest = []

        if credentials:
            rest.append("[+] Potential CORS Misconfiguration with Credentials")
        if wildcard:
            rest.append("[+] CORS Misconfiguration -> Wildcard reflection")
        elif attacker_origin:
            rest.append("[+] CORS Misconfiguration -> Any malicious domain reflection")
        elif null_origin:
            rest.append("[+] CORS Misconfiguration -> Null origin reflection")
        elif subdomain:
            rest.append(
                f"[+] CORS Misconfiguration -> Subdomain for reflection (test.{domain.registered_domain})")
        elif subdomain_for_subdomain:
            rest.append(
                f"[+] CORS Misconfiguration -> Subdomain for subdomain reflection (test1.test2.{domain.registered_domain})")
            
        return rest

if __name__ == "__main__":
    url = input("Enter the target url: ")
    cookie = input("Enter your cookie: ")
    print(cors(url, cookie))

# https://portswigger.net/web-security/cors/lab-basic-origin-reflection-attack ---> https://0a0700180342ad8e8074cbb8003f00cc.web-security-academy.net/accountDetails
