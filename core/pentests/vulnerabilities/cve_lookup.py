from typing import List
import requests
import json


def extract_cves(results: dict) -> List[dict]:
    ret = []
    for vul in results.get('vulnerabilities', []):
        for _, cpe in vul.items():
            cpe_ret = {"id": cpe.get('id'), "cvss": []}
            metrics = cpe.get('metrics', {})
            if not metrics:
                continue

            for _, cvss_metrics in metrics.items():
                #print(_, cvss_metrics, end="\n\n\n\n\n")
                for cvss_met in cvss_metrics:
                    cpe_ret["cvss"].append({"cvss": cvss_met.get(
                        "cvssData", {}), "impact_score": cvss_met.get("impactScore", 0)})

            ret.append(cpe_ret)

    return ret


def cve_lookup(cpe: str) -> List[dict]:
    url = "https://services.nvd.nist.gov/rest/json/cves/2.0"
    res = requests.get(url, params={"virtualMatchString": cpe})
    # res = json.loads(open("core/pentests/vulnerabilities/test.json").read())
    if res.status_code > 200:
        return []
    return extract_cves(res.json())


if __name__ == "__main__":
    # res = json.loads(open("core/pentests/vulnerabilities/test.json").read())

    print(cve_lookup("cpe:2.3:a:pureftpd:pure-"))
